HDPE Tycoon
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HDPE Tycoon Ultimate - 3D Edition</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    :root {
      --bg-dark: #0a0a12;
      --panel-bg: rgba(15, 18, 30, 0.92);
      --panel-border: rgba(0, 242, 255, 0.15);
      --primary: #00f2ff;
      --primary-dim: rgba(0, 242, 255, 0.3);
      --secondary: #a855f7;
      --danger: #ff3366;
      --success: #10b981;
      --gold: #fbbf24;
      --text: #e2e8f0;
      --text-dim: #64748b;
      --glow-primary: 0 0 20px rgba(0, 242, 255, 0.4);
      --glow-gold: 0 0 20px rgba(251, 191, 36, 0.4);
      --chart-up: #22c55e;
      --chart-down: #ef4444;
      --chart-grid: rgba(255, 255, 255, 0.05);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    #bg-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    .game-container {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 300px 1fr 380px;
      gap: 16px;
      padding: 16px;
      min-height: 100vh;
      max-width: 1700px;
      margin: 0 auto;
    }

    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
    }

    .panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      color: var(--primary);
      letter-spacing: 2px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title i { font-size: 1rem; }

    .stats-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .stat-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 14px;
      border-left: 3px solid var(--primary);
      transition: all 0.3s;
    }

    .stat-card:hover {
      background: rgba(0, 242, 255, 0.05);
      transform: translateX(4px);
    }

    .stat-card.gold { border-left-color: var(--gold); }
    .stat-card.purple { border-left-color: var(--secondary); }
    .stat-card.green { border-left-color: var(--success); }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-top: 4px;
    }

    .stat-value.money { color: var(--gold); text-shadow: var(--glow-gold); }
    .stat-value.gas { color: var(--primary); }
    .stat-value.hdpe { color: var(--secondary); }
    .stat-value.tp { color: var(--success); }

    .center-stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    #main-btn {
      width: 200px;
      height: 200px;
      border-radius: 24px;
      background: linear-gradient(145deg, #1a1f35, #0d1020);
      border: 3px solid rgba(0, 242, 255, 0.3);
      cursor: pointer;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      box-shadow:
        0 10px 40px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 60px rgba(0, 242, 255, 0.1);
    }

    #main-btn::before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 26px;
      background: conic-gradient(from 0deg, var(--primary), var(--secondary), var(--primary));
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #main-btn:hover::before { opacity: 0.5; }

    #main-btn:hover {
      transform: translateY(-4px);
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.6),
        0 0 80px rgba(0, 242, 255, 0.2);
    }

    #main-btn:active {
      transform: translateY(2px) scale(0.96);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
    }

    #main-btn .icon {
      font-size: 3.5rem;
      color: var(--primary);
      filter: drop-shadow(0 0 20px var(--primary));
      transition: all 0.3s;
    }

    #main-btn:hover .icon {
      transform: scale(1.1);
      filter: drop-shadow(0 0 30px var(--primary));
    }

    #main-btn .label {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      margin-top: 10px;
      letter-spacing: 2px;
      color: var(--text);
    }

    .temp-container {
      width: 80%;
      max-width: 300px;
      margin-top: 30px;
    }

    .temp-gauge {
      height: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      overflow: hidden;
    }

    .temp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--gold), var(--danger));
      border-radius: 10px;
      transition: width 0.2s;
    }

    .temp-label {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .temp-value {
      font-family: 'Orbitron', sans-serif;
      color: var(--text);
    }

    #overheat-warning {
      color: var(--danger);
      font-weight: bold;
      margin-top: 16px;
      animation: pulse 0.5s infinite;
      display: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .action-row {
      display: flex;
      gap: 12px;
      margin-top: 30px;
    }

    .action-btn {
      padding: 12px 24px;
      border-radius: 12px;
      border: 1px solid;
      background: rgba(0, 0, 0, 0.4);
      font-family: 'Rajdhani', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn.compress { border-color: var(--primary); color: var(--primary); }
    .action-btn.sell { border-color: var(--gold); color: var(--gold); }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .action-btn.compress:hover { background: rgba(0, 242, 255, 0.1); }
    .action-btn.sell:hover { background: rgba(251, 191, 36, 0.1); }

    .tab-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tab-header {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      background: transparent;
      border: none;
      border-radius: 10px;
      color: var(--text-dim);
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .tab-btn i { font-size: 1rem; }
    .tab-btn:hover { color: var(--text); background: rgba(255, 255, 255, 0.05); }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3);
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
    }

    .tab-content.active { display: flex; flex-direction: column; gap: 10px; }

    .tab-content::-webkit-scrollbar { width: 4px; }
    .tab-content::-webkit-scrollbar-thumb {
      background: var(--primary-dim);
      border-radius: 4px;
    }

    .upgrade-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .upgrade-card:hover {
      background: rgba(0, 242, 255, 0.05);
      border-color: var(--primary-dim);
      transform: translateX(4px);
    }

    .upgrade-info h4 {
      color: var(--text);
      font-size: 0.95rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upgrade-info h4 i { color: var(--primary); font-size: 0.85rem; }
    .upgrade-info small { color: var(--text-dim); font-size: 0.75rem; }

    .upgrade-meta { text-align: right; }

    .upgrade-cost {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      color: var(--gold);
    }

    .upgrade-level {
      display: inline-block;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    .invest-section {
      background: linear-gradient(135deg, rgba(255, 0, 85, 0.1), transparent);
      border: 1px solid rgba(255, 0, 85, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: auto;
    }

    .invest-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .invest-title {
      font-size: 0.8rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .win-chance {
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
    }

    .chance-bar {
      height: 6px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      margin-bottom: 12px;
    }

    .chance-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--danger), var(--gold), var(--success));
      transition: width 0.05s linear;
    }

    .chance-marker {
      position: absolute;
      left: 50%;
      top: 0;
      height: 100%;
      width: 2px;
      background: white;
      opacity: 0.5;
    }

    #invest-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
      border: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 10px;
      color: white;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    #invest-btn:hover {
      background: linear-gradient(135deg, #991b1b, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 0, 0, 0.3);
    }

    #invest-btn small {
      display: block;
      font-family: 'Rajdhani', sans-serif;
      font-weight: normal;
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 4px;
    }

    /* ============================================
       PROFESSIONAL CHART STYLES (base)
       ============================================ */
    .market-panel {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .market-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      gap: 12px;
    }

    .market-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .market-pair {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .market-pair .badge {
      font-size: 0.6rem;
      background: var(--secondary);
      padding: 2px 6px;
      border-radius: 4px;
      color: white;
    }

    .price-row {
      display: flex;
      align-items: baseline;
      gap: 12px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .current-price {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      font-weight: 900;
    }

    .current-price.up { color: var(--chart-up); }
    .current-price.down { color: var(--chart-down); }

    .price-change {
      font-size: 0.85rem;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .price-change.up {
      background: rgba(34, 197, 94, 0.2);
      color: var(--chart-up);
    }
    .price-change.down {
      background: rgba(239, 68, 68, 0.2);
      color: var(--chart-down);
    }

    .chart-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chart-type-btn {
      padding: 8px 14px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text-dim);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chart-type-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }

    .chart-type-btn.active {
      background: rgba(0, 242, 255, 0.15);
      border-color: var(--primary);
      color: var(--primary);
    }

    .chart-wrapper {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      min-height: 280px;
      overflow: hidden;
    }

    /* Grid Background */
    .chart-grid {
      position: absolute;
      inset: 16px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
    }

    .grid-line {
      height: 1px;
      background: var(--chart-grid);
      position: relative;
    }

    .grid-line::after {
      content: attr(data-price);
      position: absolute;
      right: 0;
      top: -8px;
      font-size: 0.65rem;
      color: var(--text-dim);
      transform: translateX(calc(100% + 8px));
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 100%;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding-right: 50px;
    }

    /* Candlestick Styles */
    .candle {
      flex: 1;
      position: relative;
      display: flex;
      justify-content: center;
      min-width: 8px;
      cursor: crosshair;
      transition: opacity 0.2s;
    }

    .candle:hover { z-index: 10; }
    .candle:hover .candle-body { filter: brightness(1.3); }

    .candle-wick {
      position: absolute;
      width: 1px;
      left: 50%;
      transform: translateX(-50%);
    }

    .candle-wick.up { background: var(--chart-up); }
    .candle-wick.down { background: var(--chart-down); }

    .candle-body {
      position: absolute;
      width: 70%;
      max-width: 12px;
      min-width: 4px;
      border-radius: 1px;
      left: 50%;
      transform: translateX(-50%);
      transition: filter 0.2s;
    }

    .candle-body.up {
      background: var(--chart-up);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
    }

    .candle-body.down {
      background: var(--chart-down);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
    }

    .candle-body.hollow {
      background: transparent !important;
      border: 1px solid var(--chart-up);
    }

    /* Line Chart */
    .line-chart-svg {
      position: absolute;
      inset: 16px;
      right: 66px;
      overflow: visible;
    }

    .line-path {
      fill: none;
      stroke: var(--primary);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 6px var(--primary));
    }

    .line-area { fill: url(#lineGradient); }

    .line-dot {
      fill: var(--primary);
      stroke: var(--bg-dark);
      stroke-width: 2;
      cursor: pointer;
      transition: all 0.2s;
    }

    .line-dot:hover {
      r: 6;
      filter: drop-shadow(0 0 10px var(--primary));
    }

    /* Current Price Line */
    .price-line {
      position: absolute;
      right: 50px;
      left: 0;
      height: 1px;
      border-top: 1px dashed;
      pointer-events: none;
      z-index: 5;
    }

    .price-line.up { border-color: var(--chart-up); }
    .price-line.down { border-color: var(--chart-down); }

    .price-tag {
      position: absolute;
      right: -50px;
      top: -10px;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .price-tag.up { background: var(--chart-up); color: white; }
    .price-tag.down { background: var(--chart-down); color: white; }

    /* Chart Stats */
    .chart-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }

    .chart-stat { text-align: center; }

    .chart-stat-label {
      font-size: 0.65rem;
      color: var(--text-dim);
      text-transform: uppercase;
    }

    .chart-stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      margin-top: 2px;
    }

    .chart-stat-value.high { color: var(--chart-up); }
    .chart-stat-value.low { color: var(--chart-down); }

    /* Time labels */
    .chart-time-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.65rem;
      color: var(--text-dim);
      padding-right: 50px;
    }

    /* Volume bars */
    .volume-container {
      height: 40px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding-right: 50px;
      margin-top: 8px;
      border-top: 1px solid var(--chart-grid);
      padding-top: 8px;
    }

    .volume-bar {
      flex: 1;
      min-width: 8px;
      border-radius: 2px 2px 0 0;
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .volume-bar.up { background: var(--chart-up); }
    .volume-bar.down { background: var(--chart-down); }
    .volume-bar:hover { opacity: 1; }

    /* Talent Tree Styles */
    .talent-header {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), transparent);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }

    .tp-display {
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
      font-weight: 900;
      color: var(--success);
    }

    .tp-buy-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }

    .tp-buy-row input {
      width: 60px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: white;
      text-align: center;
      font-family: inherit;
    }

    .tp-buy-row button {
      padding: 8px 16px;
      background: var(--success);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tp-buy-row button:hover { transform: scale(1.05); }

    .talent-node {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 14px;
      display: flex;
      gap: 12px;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .talent-node:hover {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.05);
    }

    .talent-node.locked { opacity: 0.5; cursor: not-allowed; }
    .talent-node.maxed { border-color: var(--gold); }

    .talent-icon {
      width: 44px;
      height: 44px;
      background: rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--success);
      font-size: 1.2rem;
    }

    .talent-info { flex: 1; }
    .talent-name { font-weight: bold; color: var(--text); }
    .talent-desc { font-size: 0.75rem; color: var(--text-dim); }
    .talent-cost { font-size: 0.8rem; color: var(--success); margin-top: 4px; }

    .license-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
    .license-title { color: var(--gold); font-size: 0.85rem; margin-bottom: 12px; }

    .license-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px dashed rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .license-card:hover { border-color: var(--gold); }
    .license-card.owned {
      border-style: solid;
      border-color: var(--gold);
      background: rgba(251, 191, 36, 0.1);
    }

    .manager-card {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), transparent);
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }

    .manager-avatar { font-size: 3rem; margin-bottom: 12px; }

    .toggle-btn {
      padding: 12px 30px;
      background: rgba(168, 85, 247, 0.3);
      border: 1px solid var(--secondary);
      border-radius: 25px;
      color: var(--secondary);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-btn.on {
      background: var(--secondary);
      color: white;
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
    }

    .storage-display {
      text-align: center;
      padding: 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
    }

    .storage-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 3rem;
      font-weight: 900;
      color: var(--secondary);
    }

    .storage-controls {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .storage-controls input {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: white;
      font-family: inherit;
      font-size: 1rem;
    }

    .storage-btns { display: flex; gap: 10px; }

    .storage-btns button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .storage-btns .deposit { background: rgba(255, 255, 255, 0.1); color: var(--text); }
    .storage-btns .withdraw { background: var(--secondary); color: white; }

    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }

    .popup-box {
      background: linear-gradient(135deg, #1a1f35, #0d1020);
      border: 2px solid var(--primary);
      border-radius: 24px;
      padding: 40px;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 0 60px rgba(0, 242, 255, 0.3);
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from { transform: scale(0.5); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .popup-box h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
      margin-bottom: 16px;
    }

    .popup-box p {
      color: var(--text-dim);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .popup-close {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      padding: 14px 40px;
      border-radius: 12px;
      color: white;
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .popup-close:hover { transform: scale(1.05); }

    #toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99998;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: var(--panel-bg);
      border-left: 4px solid var(--primary);
      padding: 14px 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      animation: slideDown 0.3s;
      min-width: 280px;
      text-align: center;
    }

    .toast.error { border-color: var(--danger); color: var(--danger); }
    .toast.money { border-color: var(--gold); color: var(--gold); }
    .toast.success { border-color: var(--success); color: var(--success); }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .float-text {
      position: fixed;
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
      pointer-events: none;
      z-index: 9999;
      animation: floatUp 1s forwards;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    @keyframes floatUp {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-60px); }
    }

    .gas-particle {
      position: fixed;
      border-radius: 50%;
      background: radial-gradient(circle, var(--primary), transparent 70%);
      pointer-events: none;
      z-index: 100;
      animation: gasFade 1s forwards;
      filter: blur(3px);
    }

    @keyframes gasFade {
      0% { transform: scale(0.5); opacity: 0.8; }
      100% { transform: scale(2) translateY(-60px); opacity: 0; }
    }

    .coin-particle {
      position: fixed;
      font-size: 24px;
      pointer-events: none;
      z-index: 100;
      animation: coinFly 1s forwards;
    }

    @keyframes coinFly {
      0% { transform: translateY(0) rotate(0) scale(0.5); opacity: 1; }
      50% { transform: translateY(-40px) rotate(180deg) scale(1); opacity: 1; }
      100% { transform: translateY(-80px) rotate(360deg) scale(0.3); opacity: 0; }
    }

    .auto-rate {
      text-align: center;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      margin-top: 16px;
      font-size: 0.85rem;
      color: var(--text-dim);
    }

    .auto-rate span { color: var(--primary); font-weight: bold; }

    .map-selector {
      display: flex;
      gap: 10px;
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .map-btn {
      flex: 1;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: var(--text-dim);
      text-align: center;
      cursor: not-allowed;
      transition: all 0.2s;
    }

    .map-btn.active {
      border-color: var(--primary);
      background: rgba(0, 242, 255, 0.1);
      color: var(--text);
      cursor: default;
    }

    @media (max-width: 1200px) {
      .game-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
      .panel { max-height: 500px; overflow-y: auto; }
      .center-stage { min-height: 400px; }
    }

    /* =========================
       CHART PATCH (fix clip + realtime + TF + hover)
       ========================= */
    #tab-market { padding-right: 16px; } /* tr√°nh scrollbar overlay che tr·ª•c */
    .market-panel { --chart-pad: 16px; --chart-axis: 80px; }

    .ohlc-bar{
      margin-top: 6px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.72rem;
      color: var(--text-dim);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tf-controls, .type-controls { display:flex; gap:6px; }
    .tf-btn{
      padding: 8px 12px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: var(--text-dim);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .tf-btn:hover{ background: rgba(255,255,255,0.05); color: var(--text); }
    .tf-btn.active{
      background: rgba(0,242,255,0.15);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* b·ªè padding c≈© ƒë·ªÉ kh√¥ng b·ªã double-inset */
    .chart-wrapper{ padding: 0 !important; overflow: hidden; }

    /* v√πng plot ch·ª´a tr·ª•c gi√° b√™n ph·∫£i */
    .chart-plot{
      position: absolute;
      top: var(--chart-pad);
      left: var(--chart-pad);
      bottom: var(--chart-pad);
      right: calc(var(--chart-pad) + var(--chart-axis));
    }

    /* grid fill to√†n plot */
    .chart-grid{
      inset: 0 !important;
      z-index: 1;
    }
    .chart-grid .grid-line::after{ display:none !important; } /* b·ªè label ki·ªÉu c≈© */

    /* candle layer fill plot */
    .chart-container{
      position: absolute;
      inset: 0;
      height: 100%;
      padding-right: 0 !important;
      z-index: 2;
      gap: 1px;
    }

    /* n·∫øn nh·ªè h∆°n ƒë·ªÉ fit 60 bars */
    .candle{ min-width: 4px !important; }
    .candle-body{ min-width: 2px !important; }

    /* line layer fill plot */
    .line-chart-svg{
      inset: 0 !important;
      right: auto !important;
      width: 100%;
      height: 100%;
      z-index: 2;
      opacity: 0;
      pointer-events: none;
    }

    /* price line trong plot */
    .price-line{ left: 0 !important; right: 0 !important; z-index: 3; }

    /* price tag n·∫±m ·ªü v√πng tr·ª•c (nh∆∞ng v·∫´n trong wrapper) */
    .price-tag{
      right: calc(-1 * var(--chart-axis) + 10px);
      width: calc(var(--chart-axis) - 14px);
      text-align: center;
    }

    /* y-axis labels */
    .y-axis{
      position: absolute;
      top: var(--chart-pad);
      bottom: var(--chart-pad);
      right: 0;
      width: calc(var(--chart-axis) + var(--chart-pad));
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
      z-index: 3;
      padding-right: 6px;
    }
    .y-axis .y-label{
      font-size: 0.65rem;
      color: var(--text-dim);
      text-align: right;
      line-height: 1;
    }

    /* align time + volume v·ªõi plot (ch·ª´a tr·ª•c gi√°) */
    .chart-time-labels{
      padding-left: var(--chart-pad);
      padding-right: calc(var(--chart-axis) + var(--chart-pad));
    }
    .volume-container{
      padding-left: var(--chart-pad);
      padding-right: calc(var(--chart-axis) + var(--chart-pad));
    }
    .volume-bar{ min-width: 4px !important; transition: height .18s ease, opacity .2s; }

    /* smooth animation */
    .candle-wick,
    .candle-body{ transition: bottom .18s ease, height .18s ease, filter .18s ease; }

    /* crosshair */
    .crosshair{
      position: absolute;
      pointer-events: none;
      z-index: 5;
      display: none;
    }
    .crosshair.v{
      top: 0; bottom: 0;
      width: 1px;
      background: rgba(255,255,255,0.25);
    }
    .crosshair.h{
      left: 0; right: 0;
      height: 1px;
      background: rgba(255,255,255,0.25);
    }
    .crosshair-price{
      position: absolute;
      right: calc(-1 * var(--chart-axis) + 10px);
      transform: translateY(-50%);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      background: rgba(20,20,30,0.95);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      display: none;
      z-index: 6;
      width: calc(var(--chart-axis) - 14px);
      text-align: center;
    }
    .crosshair-time{
      position: absolute;
      bottom: 6px;
      transform: translateX(-50%);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      background: rgba(20,20,30,0.95);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      display: none;
      z-index: 6;
      white-space: nowrap;
    }

    /* tooltip fixed ƒë·ªÉ kh√¥ng b·ªã overflow c·∫Øt */
    .chart-tooltip{
      position: fixed;
      z-index: 99999;
      display: none;
      background: rgba(20,20,30,0.95);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.75rem;
      min-width: 190px;
      pointer-events: none;
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body>

  <canvas id="bg-canvas"></canvas>
  <div id="toast-container"></div>

  <div class="game-container">
    <!-- Left Panel -->
    <div class="panel">
      <div class="panel-title"><i class="fas fa-industry"></i> X∆Ø·ªûNG S·ªê 1</div>

      <div class="stats-grid">
        <div class="stat-card gold">
          <div class="stat-label"><i class="fas fa-wallet"></i> T√†i s·∫£n</div>
          <div class="stat-value money">$<span id="money-display">0</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-wind"></i> Kh√≠ Gas</div>
          <div class="stat-value gas"><span id="gas-display">0</span> <small>L</small></div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label"><i class="fas fa-cubes"></i> Nh·ª±a HDPE</div>
          <div class="stat-value hdpe"><span id="hdpe-display">0</span> <small>kg</small></div>
        </div>
        <div class="stat-card green">
          <div class="stat-label"><i class="fas fa-brain"></i> ƒêi·ªÉm TP</div>
          <div class="stat-value tp"><span id="tp-display">0</span></div>
        </div>
      </div>

      <div class="auto-rate">
        S·∫£n l∆∞·ª£ng t·ª± ƒë·ªông: <span id="auto-rate-display">0</span> /s
      </div>

      <div class="invest-section">
        <div class="invest-header">
          <span class="invest-title">T·ª∑ l·ªá th·∫Øng</span>
          <span id="win-chance-txt" class="win-chance" style="color: var(--gold);">50%</span>
        </div>
        <div class="chance-bar">
          <div id="chance-fill" class="chance-fill" style="width: 50%;"></div>
          <div class="chance-marker"></div>
        </div>
        <button id="invest-btn" onclick="investRisky()">
          <i class="fas fa-dice"></i> ƒê·∫¶U T∆Ø T·∫§T TAY
          <small>C·∫ßn t·ªëi thi·ªÉu $5,000</small>
        </button>
      </div>

      <div class="map-selector">
        <div class="map-btn active"><i class="fas fa-industry"></i> X∆∞·ªüng 1</div>
        <div class="map-btn"><i class="fas fa-lock"></i> X∆∞·ªüng 2</div>
      </div>
    </div>

    <!-- Center Panel -->
    <div class="panel center-stage">
      <button id="main-btn" onclick="clickMine(event)">
        <i class="fas fa-compress-alt icon"></i>
        <div class="label">H√öT KH√ç</div>
      </button>

      <div class="temp-container">
        <div class="temp-gauge">
          <div class="temp-fill" id="temp-bar" style="width: 0%;"></div>
        </div>
        <div class="temp-label">
          <span>NHI·ªÜT ƒê·ªò M√ÅY</span>
          <span class="temp-value"><span id="temp-val">0</span>¬∞C</span>
        </div>
      </div>

      <div id="overheat-warning">‚ö†Ô∏è M√ÅY QU√Å NHI·ªÜT! ƒêANG L√ÄM M√ÅT...</div>

      <div class="action-row">
        <button class="action-btn compress" onclick="convertResource()">
          <i class="fas fa-compress-arrows-alt"></i>
          N√©n Kh√≠ (5L ‚Üí 1kg)
        </button>
        <button class="action-btn sell" onclick="sellAll()">
          <i class="fas fa-dollar-sign"></i>
          B√°n H·∫øt Kho
        </button>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="panel tab-container">
      <div class="tab-header">
        <button class="tab-btn active" onclick="switchTab('upgrade')">
          <i class="fas fa-hammer"></i><span>N√¢ng C·∫•p</span>
        </button>
        <button class="tab-btn" onclick="switchTab('talent')">
          <i class="fas fa-brain"></i><span>Thi√™n Ph√∫</span>
        </button>
        <button class="tab-btn" onclick="switchTab('manager')">
          <i class="fas fa-user-tie"></i><span>Qu·∫£n L√Ω</span>
        </button>
        <button class="tab-btn" onclick="switchTab('storage')">
          <i class="fas fa-warehouse"></i><span>Kho</span>
        </button>
        <button class="tab-btn" onclick="switchTab('market')">
          <i class="fas fa-chart-line"></i><span>Th·ªã Tr∆∞·ªùng</span>
        </button>
      </div>

      <!-- Upgrade Tab -->
      <div id="tab-upgrade" class="tab-content active">
        <div class="upgrade-card" onclick="buyUpgrade('clicker')">
          <div class="upgrade-info">
            <h4><i class="fas fa-hand-pointer"></i> Van √Åp Su·∫•t</h4>
            <small>TƒÉng l∆∞·ª£ng kh√≠ m·ªói l·∫ßn b·∫•m</small>
          </div>
          <div class="upgrade-meta">
            <div class="upgrade-cost">$<span id="cost-clicker">50</span></div>
            <div class="upgrade-level">Lv.<span id="lvl-clicker">1</span></div>
          </div>
        </div>
        <div class="upgrade-card" onclick="buyUpgrade('miner')">
          <div class="upgrade-info">
            <h4><i class="fas fa-robot"></i> M√°y H√∫t T·ª± ƒê·ªông</h4>
            <small>T·ª± ƒë·ªông h√∫t kh√≠ m·ªói gi√¢y</small>
          </div>
          <div class="upgrade-meta">
            <div class="upgrade-cost">$<span id="cost-miner">200</span></div>
            <div class="upgrade-level">Lv.<span id="lvl-miner">0</span></div>
          </div>
        </div>
        <div class="upgrade-card" onclick="buyUpgrade('coolant')">
          <div class="upgrade-info">
            <h4><i class="fas fa-snowflake"></i> H·ªá Th·ªëng T·∫£n Nhi·ªát</h4>
            <small>Gi·∫£m nhi·ªát ƒë·ªô nhanh h∆°n</small>
          </div>
          <div class="upgrade-meta">
            <div class="upgrade-cost">$<span id="cost-coolant">500</span></div>
            <div class="upgrade-level">Lv.<span id="lvl-coolant">1</span></div>
          </div>
        </div>
        <div class="upgrade-card" onclick="buyUpgrade('compressor')">
          <div class="upgrade-info">
            <h4><i class="fas fa-compress"></i> M√°y N√©n Auto</h4>
            <small>T·ª± ƒë·ªông n√©n Kh√≠ th√†nh Nh·ª±a</small>
          </div>
          <div class="upgrade-meta">
            <div class="upgrade-cost">$<span id="cost-compressor">1000</span></div>
            <div class="upgrade-level">Lv.<span id="lvl-compressor">0</span></div>
          </div>
        </div>
      </div>

      <!-- Talent Tab -->
      <div id="tab-talent" class="tab-content">
        <div class="talent-header">
          <div class="tp-display"><span id="tp-val-big">0</span> TP</div>
          <div class="tp-buy-row">
            <input type="number" id="tp-buy-input" value="1" min="1">
            <button onclick="buyTP()">MUA ($1k/ƒëi·ªÉm)</button>
          </div>
        </div>
        <div class="talent-node" onclick="upgradeTalent('efficiency')">
          <div class="talent-icon"><i class="fas fa-hand-sparkles"></i></div>
          <div class="talent-info">
            <div class="talent-name">Hi·ªáu Su·∫•t Tay</div>
            <div class="talent-desc">TƒÉng l·ª±c h√∫t khi click (+10%/c·∫•p)</div>
            <div class="talent-cost">Chi ph√≠: <span id="cost-talent-efficiency">1</span> TP</div>
          </div>
          <div class="upgrade-level">Lv.<span id="lvl-talent-efficiency">0</span>/20</div>
        </div>
        <div class="talent-node locked" id="node-luck" onclick="upgradeTalent('luck')">
          <div class="talent-icon"><i class="fas fa-dice"></i></div>
          <div class="talent-info">
            <div class="talent-name">May M·∫Øn Khai Th√°c</div>
            <div class="talent-desc">5% c∆° h·ªôi h√∫t x10 kh√≠</div>
            <div class="talent-cost">Y√™u c·∫ßu: Hi·ªáu Su·∫•t Lv.5</div>
          </div>
          <div class="upgrade-level">Lv.<span id="lvl-talent-luck">0</span>/10</div>
        </div>
        <div class="talent-node" onclick="upgradeTalent('grease')">
          <div class="talent-icon"><i class="fas fa-oil-can"></i></div>
          <div class="talent-info">
            <div class="talent-name">B√¥i Tr∆°n M√°y</div>
            <div class="talent-desc">TƒÉng t·ªëc ƒë·ªô Auto Miner (+5%/c·∫•p)</div>
            <div class="talent-cost">Chi ph√≠: <span id="cost-talent-grease">1</span> TP</div>
          </div>
          <div class="upgrade-level">Lv.<span id="lvl-talent-grease">0</span>/50</div>
        </div>
        <div class="license-section">
          <div class="license-title"><i class="fas fa-certificate"></i> GI·∫§Y PH√âP</div>
          <div class="license-card" id="lic-export" onclick="buyLicense('export')">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
              <span style="font-weight:bold;"><i class="fas fa-globe"></i> Gi·∫•y Ph√©p Xu·∫•t Kh·∫©u</span>
              <span style="color:var(--gold);">$500,000</span>
            </div>
            <div style="font-size:0.75rem; color:var(--text-dim);">Gi√° b√°n nh·ª±a +20%</div>
            <div style="margin-top:6px;">
              <span id="req-export-lvl" style="font-size:0.7rem; background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:4px;">C·∫ßn: Hi·ªáu Su·∫•t Lv.10</span>
            </div>
          </div>
          <div class="license-card" id="lic-cooling" onclick="buyLicense('cooling')">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
              <span style="font-weight:bold;"><i class="fas fa-snowflake"></i> ISO M√¥i Tr∆∞·ªùng</span>
              <span style="color:var(--gold);">$1,000,000</span>
            </div>
            <div style="font-size:0.75rem; color:var(--text-dim);">Gi·∫£m 50% nhi·ªát sinh ra</div>
            <div style="margin-top:6px;">
              <span id="req-cooling-res" style="font-size:0.7rem; background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:4px;">C·∫ßn: 50,000kg trong kho</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Manager Tab -->
      <div id="tab-manager" class="tab-content">
        <div class="manager-card">
          <div class="manager-avatar">üë®‚Äçüíº</div>
          <h3 style="margin-bottom:8px;">Gi√°m ƒê·ªëc K·ªπ Thu·∫≠t</h3>
          <p style="font-size:0.85rem; color:var(--text-dim); margin-bottom:20px;">
            "T√¥i s·∫Ω t·ª± ƒë·ªông n√¢ng c·∫•p m√°y m√≥c cho b·∫°n."
          </p>
          <div id="manager-locked">
            <button class="toggle-btn" onclick="hireManager()">THU√ä: $1,000,000</button>
          </div>
          <div id="manager-unlocked" style="display:none;">
            <div style="margin-bottom:12px;">
              Tr·∫°ng th√°i: <span id="mgr-status-text" style="color:var(--secondary);">ƒêANG T·∫ÆT</span>
            </div>
            <button id="mgr-toggle" class="toggle-btn" onclick="toggleManager()">B·∫¨T QU·∫¢N L√ù</button>
          </div>
        </div>
      </div>

      <!-- Storage Tab -->
      <div id="tab-storage" class="tab-content">
        <div class="storage-display">
          <div style="font-size:0.85rem; color:var(--text-dim); margin-bottom:8px;">KHO TR·ªÆ NH·ª∞A</div>
          <div class="storage-value"><span id="storage-display">0</span></div>
          <div style="font-size:0.9rem; color:var(--text-dim);">kg</div>
        </div>
        <div class="storage-controls">
          <input type="number" id="storage-input" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng...">
          <div class="storage-btns">
            <button class="deposit" onclick="depositAll()"><i class="fas fa-arrow-down"></i> G·ª≠i H·∫øt</button>
            <button class="withdraw" onclick="withdrawX()"><i class="fas fa-arrow-up"></i> R√∫t Ra</button>
          </div>
        </div>
      </div>

      <!-- Market Tab -->
      <div id="tab-market" class="tab-content market-panel">
        <div class="market-header">
          <div class="market-info">
            <div class="market-pair">
              HDPE/USD <span class="badge">SPOT</span>
            </div>

            <div class="price-row">
              <div id="current-price-display" class="current-price up">$10.00</div>
              <div id="price-change-display" class="price-change up">+0.00%</div>
            </div>

            <div id="ohlc-bar" class="ohlc-bar">O: -- H: -- L: -- C: --</div>
          </div>

          <div class="chart-controls">
            <div class="tf-controls">
              <button class="tf-btn active" id="tf-1m" onclick="setTimeframe('1m')">1m</button>
              <button class="tf-btn" id="tf-5m" onclick="setTimeframe('5m')">5m</button>
              <button class="tf-btn" id="tf-15m" onclick="setTimeframe('15m')">15m</button>
            </div>

            <div class="type-controls">
              <button class="chart-type-btn active" onclick="setChartType('candle')" id="btn-candle">
                <i class="fas fa-chart-bar"></i> N·∫øn
              </button>
              <button class="chart-type-btn" onclick="setChartType('line')" id="btn-line">
                <i class="fas fa-chart-line"></i> ƒê∆∞·ªùng
              </button>
            </div>
          </div>
        </div>

        <div class="chart-wrapper" id="chart-wrapper">
          <div class="chart-plot" id="chart-plot">
            <div class="chart-grid" id="chart-grid"></div>

            <svg class="line-chart-svg" id="line-chart" preserveAspectRatio="none">
              <defs>
                <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color: rgba(0, 242, 255, 0.3)" />
                  <stop offset="100%" style="stop-color: rgba(0, 242, 255, 0)" />
                </linearGradient>
              </defs>
              <path class="line-area" id="line-area"></path>
              <path class="line-path" id="line-path"></path>
              <g id="line-dots"></g>
            </svg>

            <div class="chart-container" id="chart-display"></div>

            <div class="price-line" id="price-line">
              <div class="price-tag" id="price-tag">$10.00</div>
            </div>

            <div class="crosshair v" id="crosshair-v"></div>
            <div class="crosshair h" id="crosshair-h"></div>
            <div class="crosshair-price" id="crosshair-price"></div>
            <div class="crosshair-time" id="crosshair-time"></div>
          </div>

          <div class="y-axis" id="y-axis"></div>
          <div class="chart-tooltip" id="chart-tooltip"></div>
        </div>

        <div class="chart-time-labels" id="chart-time-labels">
          <span></span><span></span><span></span><span></span><span></span>
        </div>

        <div class="volume-container" id="volume-display"></div>

        <div class="chart-stats">
          <div class="chart-stat">
            <div class="chart-stat-label">24h High</div>
            <div class="chart-stat-value high" id="stat-high">$0.00</div>
          </div>
          <div class="chart-stat">
            <div class="chart-stat-label">24h Low</div>
            <div class="chart-stat-value low" id="stat-low">$0.00</div>
          </div>
          <div class="chart-stat">
            <div class="chart-stat-label">24h Vol</div>
            <div class="chart-stat-value" id="stat-vol">0</div>
          </div>
          <div class="chart-stat">
            <div class="chart-stat-label">Avg</div>
            <div class="chart-stat-value" id="stat-avg">$0.00</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup -->
  <div id="custom-popup" class="popup-overlay">
    <div class="popup-box">
      <h1 id="p-title">TH√îNG B√ÅO</h1>
      <p id="p-message">N·ªôi dung th√¥ng b√°o</p>
      <button class="popup-close" onclick="closeMyPopup()">X√ÅC NH·∫¨N</button>
    </div>
  </div>

<script>
/* ============================================
   THREE.JS BACKGROUND
   ============================================ */
const canvas = document.getElementById('bg-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.z = 50;

const particleCount = 1500;
const positions = new Float32Array(particleCount * 3);
const colors = new Float32Array(particleCount * 3);

for (let i = 0; i < particleCount; i++) {
  positions[i * 3] = (Math.random() - 0.5) * 200;
  positions[i * 3 + 1] = (Math.random() - 0.5) * 200;
  positions[i * 3 + 2] = (Math.random() - 0.5) * 200;
  const t = Math.random();
  colors[i * 3] = t * 0.5;
  colors[i * 3 + 1] = 0.8 + t * 0.2;
  colors[i * 3 + 2] = 1;
}

const particleGeometry = new THREE.BufferGeometry();
particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

const particleMaterial = new THREE.PointsMaterial({
  size: 1,
  vertexColors: true,
  transparent: true,
  opacity: 0.6,
  blending: THREE.AdditiveBlending
});

const particles = new THREE.Points(particleGeometry, particleMaterial);
scene.add(particles);

const cubes = [];
for (let i = 0; i < 12; i++) {
  const geometry = new THREE.BoxGeometry(2 + Math.random() * 3, 2 + Math.random() * 3, 2 + Math.random() * 3);
  const material = new THREE.MeshBasicMaterial({
    color: new THREE.Color().setHSL(0.5 + Math.random() * 0.2, 0.8, 0.5),
    transparent: true,
    opacity: 0.12,
    wireframe: true
  });
  const cube = new THREE.Mesh(geometry, material);
  cube.position.set((Math.random() - 0.5) * 100, (Math.random() - 0.5) * 100, (Math.random() - 0.5) * 50);
  cube.userData = {
    rotSpeed: { x: Math.random() * 0.01, y: Math.random() * 0.01 },
    floatSpeed: Math.random() * 0.5 + 0.2,
    floatOffset: Math.random() * Math.PI * 2
  };
  scene.add(cube);
  cubes.push(cube);
}

let time = 0;
function animate() {
  requestAnimationFrame(animate);
  time += 0.01;
  particles.rotation.y = time * 0.05;
  particles.rotation.x = Math.sin(time * 0.1) * 0.1;
  cubes.forEach(cube => {
    cube.rotation.x += cube.userData.rotSpeed.x;
    cube.rotation.y += cube.userData.rotSpeed.y;
    cube.position.y += Math.sin(time * cube.userData.floatSpeed + cube.userData.floatOffset) * 0.02;
  });
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  drawChart(); // chart patch
});

/* ============================================
   GAME DATA
   ============================================ */
let game = {
  money: 0, gas: 0, hdpe: 0, temp: 0, storage: 0, isOverheat: false,
  manager: { owned: false, active: false, timer: 0 },
  items: {
    clicker: { lv: 1, cost: 50, name: "Van √Åp Su·∫•t" },
    miner: { lv: 0, cost: 200, name: "M√°y H√∫t T·ª± ƒê·ªông" },
    coolant: { lv: 1, cost: 500, name: "T·∫£n Nhi·ªát" },
    compressor: { lv: 0, cost: 1000, name: "M√°y N√©n Auto" }
  },
  invest: { chance: 50, direction: 1, speed: 2 },
  talent: { tp: 0, levels: { efficiency: 0, luck: 0, grease: 0 } },
  licenses: { export: false, cooling: false },

  market: {
    currentPrice: 10,
    previousPrice: 10,
    allTimeHigh: 10,
    allTimeLow: 10,
    volume: 0,

    timeframe: '1m',
    candles: { '1m': [], '5m': [], '15m': [] },
    currentCandles: { '1m': null, '5m': null, '15m': null },

    view: { minP: 0, maxP: 0, range: 1 },
    maxBars: 60
  },

  chartType: 'candle' // 'candle' or 'line'
};

/* ============================================
   HELPER FUNCTIONS
   ============================================ */
function createToast(msg, type = 'normal') {
  const container = document.getElementById('toast-container');
  while (container.children.length >= 3) container.removeChild(container.firstChild);
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = msg;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function createFloatText(x, y, text, color) {
  const el = document.createElement('div');
  el.className = 'float-text';
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.style.color = color;
  el.innerText = text;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function createGasParticles(x, y, count = 8) {
  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.className = 'gas-particle';
    const size = 20 + Math.random() * 30;
    particle.style.width = size + 'px';
    particle.style.height = size + 'px';
    particle.style.left = (x + (Math.random() - 0.5) * 100) + 'px';
    particle.style.top = (y + (Math.random() - 0.5) * 50) + 'px';
    document.body.appendChild(particle);
    setTimeout(() => particle.remove(), 1000);
  }
}

function createCoinParticles(x, y, count = 10) {
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const coin = document.createElement('div');
      coin.className = 'coin-particle';
      coin.innerText = 'üí∞';
      coin.style.left = (x + (Math.random() - 0.5) * 80) + 'px';
      coin.style.top = y + 'px';
      document.body.appendChild(coin);
      setTimeout(() => coin.remove(), 1000);
    }, i * 40);
  }
}

function showMyPopup(title, message, titleColor) {
  document.getElementById('p-title').innerText = title;
  document.getElementById('p-title').style.color = titleColor;
  document.getElementById('p-message').innerHTML = message;
  document.getElementById('custom-popup').style.display = 'flex';
}

function closeMyPopup() {
  document.getElementById('custom-popup').style.display = 'none';
}

/* ============================================
   CORE GAME FUNCTIONS
   ============================================ */
function clickMine(e) {
  if (game.isOverheat) {
    createToast("M√ÅY ƒêANG QU√Å T·∫¢I!", "error");
    return;
  }
  const btn = document.getElementById('main-btn');
  const rect = btn.getBoundingClientRect();
  createGasParticles(rect.left + rect.width / 2, rect.top + rect.height / 2);

  let baseAmount = 1 + (game.items.clicker.lv * 0.5);
  let talentMult = 1 + (game.talent.levels.efficiency * 0.1);
  let finalAmount = baseAmount * talentMult;

  if (Math.random() < game.talent.levels.luck * 0.05) {
    finalAmount *= 10;
    createFloatText(e.clientX, e.clientY, "CRIT X10!", "#fbbf24");
  }

  game.gas += finalAmount;
  game.temp += game.licenses.cooling ? 1 : 2;
  if (game.temp >= 100) {
    game.temp = 100;
    game.isOverheat = true;
    createToast("H·ªÜ TH·ªêNG QU√Å NHI·ªÜT!", "error");
  }
  createFloatText(e.clientX, e.clientY, `+${finalAmount.toFixed(1)} Gas`, '#00f2ff');
  updateUI();
}

function convertResource() {
  if (game.gas >= 5) {
    createGasParticles(window.innerWidth / 2, window.innerHeight / 2, 12);
    let packs = Math.floor(game.gas / 5);
    game.gas -= packs * 5;
    game.hdpe += packs;
    createToast(`N√©n ƒë∆∞·ª£c ${packs}kg Nh·ª±a HDPE`, 'success');
    updateUI();
  } else {
    createToast('C·∫ßn √≠t nh·∫•t 5L kh√≠!', 'error');
  }
}

function sellAll() {
  if (game.hdpe <= 0) { createToast('Kh√¥ng c√≥ h√†ng!', 'error'); return; }
  createCoinParticles(window.innerWidth / 2, window.innerHeight / 2, 15);
  let price = game.market.currentPrice;
  if (game.licenses.export) price *= 1.2;

  const qty = game.hdpe;
  let earned = Math.floor(qty * price);

  // c·ªông volume v√†o candle hi·ªán t·∫°i ƒë·ªÉ chart ‚Äúgi·ªëng s√†n‚Äù h∆°n
  if (typeof TIMEFRAMES !== 'undefined') {
    Object.keys(TIMEFRAMES).forEach(tf => {
      const c = game.market.currentCandles[tf];
      if (c) c.volume += qty;
    });
  }

  game.market.volume += qty;
  game.money += earned;
  game.hdpe = 0;
  createToast(`B√°n v·ªõi gi√° $${price.toFixed(2)}/kg ‚Üí Thu $${earned.toLocaleString()}`, 'money');
  updateUI();
}

function buyUpgrade(type) {
  const item = game.items[type];
  if (game.money >= item.cost) {
    game.money -= item.cost;
    item.lv++;
    item.cost = Math.floor(item.cost * 1.5);
    createToast(`N√¢ng c·∫•p ${item.name} l√™n Lv.${item.lv}`, 'success');
    updateUI();
  } else createToast('Kh√¥ng ƒë·ªß ti·ªÅn!', 'error');
}

function buyTP() {
  const amount = parseInt(document.getElementById('tp-buy-input').value) || 1;
  const totalCost = amount * 1000;
  if (game.money >= totalCost) {
    game.money -= totalCost;
    game.talent.tp += amount;
    createToast(`ƒê√£ mua ${amount} TP`, 'success');
    updateUI();
  } else createToast(`C·∫ßn $${totalCost.toLocaleString()}!`, 'error');
}

function upgradeTalent(type) {
  const currentLv = game.talent.levels[type];
  const maxLv = type === 'grease' ? 50 : (type === 'efficiency' ? 20 : 10);
  if (currentLv >= maxLv) { createToast("ƒê√£ ƒë·∫°t c·∫•p t·ªëi ƒëa!", "error"); return; }
  if (type === 'luck' && game.talent.levels.efficiency < 5) {
    createToast("C·∫ßn Hi·ªáu Su·∫•t Lv.5!", "error"); return;
  }
  const cost = Math.floor(1 + currentLv * 0.5);
  if (game.talent.tp >= cost) {
    game.talent.tp -= cost;
    game.talent.levels[type]++;
    createToast(`N√¢ng c·∫•p th√†nh c√¥ng!`, 'success');
    updateUI();
  } else createToast(`C·∫ßn ${cost} TP!`, 'error');
}

function buyLicense(type) {
  if (game.licenses[type]) return;
  let cost = 0, canBuy = false;
  if (type === 'export') {
    cost = 500000;
    canBuy = game.talent.levels.efficiency >= 10;
    if (!canBuy) createToast("Y√™u c·∫ßu: Hi·ªáu Su·∫•t Lv.10", "error");
  } else if (type === 'cooling') {
    cost = 1000000;
    canBuy = game.storage >= 50000;
    if (!canBuy) createToast("Y√™u c·∫ßu: 50,000kg trong kho", "error");
  }
  if (canBuy && game.money >= cost) {
    game.money -= cost;
    game.licenses[type] = true;
    createToast("Mua gi·∫•y ph√©p th√†nh c√¥ng!", "success");
    updateUI();
  } else if (canBuy) createToast("Kh√¥ng ƒë·ªß ti·ªÅn!", "error");
}

function depositAll() {
  if (game.hdpe > 0) {
    game.storage += game.hdpe;
    game.hdpe = 0;
    createToast('ƒê√£ g·ª≠i v√†o kho!', 'success');
    updateUI();
  } else createToast("Kh√¥ng c√≥ nh·ª±a!", "error");
}

function withdrawX() {
  const amount = parseInt(document.getElementById('storage-input').value);
  if (!amount || amount <= 0) { createToast("Nh·∫≠p s·ªë l∆∞·ª£ng!", "error"); return; }
  if (game.storage >= amount) {
    game.storage -= amount;
    game.hdpe += amount;
    createToast(`R√∫t ${amount}kg`, 'success');
    updateUI();
  } else createToast("Kho kh√¥ng ƒë·ªß!", "error");
}

function hireManager() {
  if (game.money >= 1000000) {
    game.money -= 1000000;
    game.manager.owned = true;
    document.getElementById('manager-locked').style.display = 'none';
    document.getElementById('manager-unlocked').style.display = 'block';
    createToast('ƒê√£ thu√™ Gi√°m ƒê·ªëc!', 'success');
    updateUI();
  } else createToast("Kh√¥ng ƒë·ªß ti·ªÅn!", "error");
}

function toggleManager() {
  game.manager.active = !game.manager.active;
  updateUI();
}

function switchTab(t) {
  document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
  document.getElementById('tab-' + t).classList.add('active');
  const tabIndex = { upgrade: 0, talent: 1, manager: 2, storage: 3, market: 4 };
  document.querySelectorAll('.tab-btn')[tabIndex[t]].classList.add('active');

  if (t === 'market') setTimeout(drawChart, 0);
  else { chartHover.active = false; hideCrosshair(); }
}

/* ============================================
   MARKET + CHART (REALTIME + TF + HOVER)
   ============================================ */
const TIMEFRAMES = { '1m': 60_000, '5m': 300_000, '15m': 900_000 };
const MARKET_TICK_MS = 500;
const MAX_STORE_BARS = 3000;
let chartHover = { active: false };

function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

function randn() {
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function fmtTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
}

function aggregateBy(candles1m, n) {
  const out = [];
  for (let i = 0; i < candles1m.length; i += n) {
    const slice = candles1m.slice(i, i + n);
    if (!slice.length) continue;
    const open = slice[0].open;
    const close = slice[slice.length - 1].close;
    let high = -Infinity, low = Infinity, vol = 0;
    slice.forEach(c => {
      high = Math.max(high, c.high);
      low = Math.min(low, c.low);
      vol += c.volume;
    });
    out.push({ time: slice[0].time, open, high, low, close, volume: vol });
  }
  return out;
}

function seedMarket() {
  const tfMs = TIMEFRAMES['1m'];
  const now = Date.now();
  const bucketNow = Math.floor(now / tfMs) * tfMs;

  const bars = 2000; // > 24h
  let price = game.market.currentPrice;

  const candles = [];
  let t = bucketNow - bars * tfMs;

  for (let i = 0; i < bars; i++) {
    const open = price;
    const close = clamp(open * (1 + randn() * 0.01), 3, 150);
    const high = Math.max(open, close) * (1 + Math.random() * 0.004);
    const low = Math.min(open, close) * (1 - Math.random() * 0.004);
    const volume = Math.floor(Math.random() * 900) + 100;

    candles.push({ time: t, open, high, low, close, volume });
    price = close;
    t += tfMs;
  }

  game.market.candles['1m'] = candles;
  game.market.candles['5m'] = aggregateBy(candles, 5);
  game.market.candles['15m'] = aggregateBy(candles, 15);

  const last = candles[candles.length - 1];
  game.market.currentPrice = last.close;
  game.market.previousPrice = last.close;

  let ath = -Infinity, atl = Infinity;
  candles.forEach(c => {
    ath = Math.max(ath, c.high);
    atl = Math.min(atl, c.low);
  });
  game.market.allTimeHigh = ath;
  game.market.allTimeLow = atl;

  ['1m', '5m', '15m'].forEach(tf => {
    const bucket = Math.floor(now / TIMEFRAMES[tf]) * TIMEFRAMES[tf];
    const p = last.close;
    game.market.currentCandles[tf] = { time: bucket, open: p, high: p, low: p, close: p, volume: 0 };
  });
}

function updateCandle(tf, now, price, vol) {
  const tfMs = TIMEFRAMES[tf];
  const bucket = Math.floor(now / tfMs) * tfMs;
  let c = game.market.currentCandles[tf];

  if (!c || c.time !== bucket) {
    if (c) {
      game.market.candles[tf].push(c);
      if (game.market.candles[tf].length > MAX_STORE_BARS) game.market.candles[tf].shift();
    }
    game.market.currentCandles[tf] = { time: bucket, open: price, high: price, low: price, close: price, volume: vol };
  } else {
    c.close = price;
    c.high = Math.max(c.high, price);
    c.low = Math.min(c.low, price);
    c.volume += vol;
  }
}

function marketTick() {
  const now = Date.now();
  const prev = game.market.currentPrice;

  const sigma = 0.003;
  let next = prev * (1 + randn() * sigma);
  next = clamp(next, 3, 150);

  game.market.previousPrice = prev;
  game.market.currentPrice = next;
  game.market.allTimeHigh = Math.max(game.market.allTimeHigh, next);
  game.market.allTimeLow = Math.min(game.market.allTimeLow, next);

  const vol = Math.floor(Math.random() * 80) + 20;
  game.market.volume += vol;

  updateCandle('1m', now, next, vol);
  updateCandle('5m', now, next, vol);
  updateCandle('15m', now, next, vol);

  updateMarketUI();
  drawChart();
}

function getSeriesForView() {
  const tf = game.market.timeframe;
  const closed = game.market.candles[tf] || [];
  const current = game.market.currentCandles[tf];
  const series = current ? closed.concat(current) : closed.slice();
  return series.slice(-game.market.maxBars);
}

function computeScale(series) {
  let minP = Infinity, maxP = -Infinity;
  for (const c of series) {
    if (c.low < minP) minP = c.low;
    if (c.high > maxP) maxP = c.high;
  }
  let range = maxP - minP;
  if (!isFinite(range) || range <= 0) range = 1;

  const pad = range * 0.1;
  minP -= pad;
  maxP += pad;
  range = maxP - minP;

  return { minP, maxP, range };
}

function updateGrid(minP, maxP) {
  const grid = document.getElementById('chart-grid');
  const axis = document.getElementById('y-axis');
  if (!grid || !axis) return;

  grid.innerHTML = '';
  axis.innerHTML = '';

  const steps = 5;
  const step = (maxP - minP) / steps;

  for (let i = 0; i <= steps; i++) {
    const line = document.createElement('div');
    line.className = 'grid-line';
    grid.appendChild(line);

    const p = maxP - step * i;
    const lbl = document.createElement('div');
    lbl.className = 'y-label';
    lbl.textContent = `$${p.toFixed(2)}`;
    axis.appendChild(lbl);
  }
}

function ensureChildren(container, count, factory) {
  while (container.children.length < count) container.appendChild(factory());
  while (container.children.length > count) container.removeChild(container.firstChild);
}

function makeCandleEl() {
  const candle = document.createElement('div');
  candle.className = 'candle';

  const wick = document.createElement('div');
  wick.className = 'candle-wick up';

  const body = document.createElement('div');
  body.className = 'candle-body up';

  candle.appendChild(wick);
  candle.appendChild(body);
  return candle;
}

function renderCandles(series, minP, range) {
  const container = document.getElementById('chart-display');
  if (!container) return;

  ensureChildren(container, series.length, makeCandleEl);

  series.forEach((c, i) => {
    const candle = container.children[i];
    const wick = candle.children[0];
    const body = candle.children[1];

    const isUp = c.close >= c.open;

    const h = clamp(((c.high - minP) / range) * 100, 0, 100);
    const l = clamp(((c.low - minP) / range) * 100, 0, 100);
    const o = clamp(((c.open - minP) / range) * 100, 0, 100);
    const cl = clamp(((c.close - minP) / range) * 100, 0, 100);

    wick.className = `candle-wick ${isUp ? 'up' : 'down'}`;
    wick.style.bottom = l + '%';
    wick.style.height = Math.max(0.5, h - l) + '%';

    const bodyBottom = Math.min(o, cl);
    const bodyHeight = Math.max(1, Math.abs(cl - o));
    const hollow = isUp && c.close <= c.open * 1.001;

    body.className = `candle-body ${isUp ? (hollow ? 'up hollow' : 'up') : 'down'}`;
    body.style.bottom = bodyBottom + '%';
    body.style.height = bodyHeight + '%';
  });
}

function renderLine(series, minP, range) {
  const svg = document.getElementById('line-chart');
  const plot = document.getElementById('chart-plot');
  if (!svg || !plot) return;

  const width = plot.clientWidth;
  const height = plot.clientHeight;
  if (!width || !height || series.length < 2) return;

  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

  const pts = series.map((c, i) => {
    const x = (i / (series.length - 1)) * width;
    const y = height - ((c.close - minP) / range) * height;
    return { x, y, c };
  });

  const d = pts.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(2)} ${p.y.toFixed(2)}`).join(' ');
  document.getElementById('line-path').setAttribute('d', d);

  const area = `${d} L ${width} ${height} L 0 ${height} Z`;
  document.getElementById('line-area').setAttribute('d', area);

  const dots = document.getElementById('line-dots');
  dots.innerHTML = '';
  pts.forEach((p, i) => {
    if (i % 4 === 0 || i === pts.length - 1) {
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', p.x);
      circle.setAttribute('cy', p.y);
      circle.setAttribute('r', 4);
      circle.setAttribute('class', 'line-dot');
      dots.appendChild(circle);
    }
  });
}

function renderVolume(series) {
  const container = document.getElementById('volume-display');
  if (!container) return;

  const maxVol = Math.max(...series.map(c => c.volume)) || 1;

  ensureChildren(container, series.length, () => {
    const bar = document.createElement('div');
    bar.className = 'volume-bar up';
    return bar;
  });

  series.forEach((c, i) => {
    const bar = container.children[i];
    bar.className = `volume-bar ${c.close >= c.open ? 'up' : 'down'}`;
    bar.style.height = ((c.volume / maxVol) * 100).toFixed(2) + '%';
  });
}

function renderPriceLine(minP, range) {
  const price = game.market.currentPrice;
  const priceLine = document.getElementById('price-line');
  const priceTag = document.getElementById('price-tag');
  if (!priceLine || !priceTag) return;

  const pct = clamp(((price - minP) / range) * 100, 0, 100);
  priceLine.style.bottom = pct + '%';

  const isUp = price >= game.market.previousPrice;
  priceLine.className = `price-line ${isUp ? 'up' : 'down'}`;
  priceTag.className = `price-tag ${isUp ? 'up' : 'down'}`;
  priceTag.textContent = `$${price.toFixed(2)}`;
}

function updateTimeLabels(series) {
  const cont = document.getElementById('chart-time-labels');
  if (!cont) return;

  const spans = cont.querySelectorAll('span');
  const last = series.length - 1;
  const idxs = [0, Math.floor(last * 0.25), Math.floor(last * 0.5), Math.floor(last * 0.75), last];

  idxs.forEach((idx, i) => spans[i].textContent = series[idx] ? fmtTime(series[idx].time) : '');
}

function updateOhlcBar(c) {
  const el = document.getElementById('ohlc-bar');
  if (!el || !c) return;
  const up = c.close >= c.open;

  el.innerHTML = `
    <span>O <b>$${c.open.toFixed(2)}</b></span>
    <span>H <b style="color:var(--chart-up)">$${c.high.toFixed(2)}</b></span>
    <span>L <b style="color:var(--chart-down)">$${c.low.toFixed(2)}</b></span>
    <span>C <b style="color:${up ? 'var(--chart-up)' : 'var(--chart-down)'}">$${c.close.toFixed(2)}</b></span>
    <span>V <b>${Math.round(c.volume).toLocaleString()}</b></span>
  `;
}

function compute24hStats() {
  const now = Date.now();
  const from = now - 24 * 60 * 60 * 1000;
  const base = game.market.candles['1m'] || [];
  const arr = base.filter(c => c.time >= from);
  const cur = game.market.currentCandles['1m'];
  if (cur && cur.time >= from) arr.push(cur);
  if (!arr.length) return null;

  let high = -Infinity, low = Infinity, vol = 0;
  arr.forEach(c => { high = Math.max(high, c.high); low = Math.min(low, c.low); vol += c.volume; });
  return { high, low, vol };
}

function updateMarketUI() {
  const price = game.market.currentPrice;
  const prev = game.market.previousPrice || price;
  const isUp = price >= prev;
  const changePercent = prev ? ((price - prev) / prev * 100).toFixed(2) : '0.00';

  const priceEl = document.getElementById('current-price-display');
  if (priceEl) {
    priceEl.innerText = `$${price.toFixed(2)}`;
    priceEl.className = `current-price ${isUp ? 'up' : 'down'}`;
  }

  const changeEl = document.getElementById('price-change-display');
  if (changeEl) {
    changeEl.innerText = `${isUp ? '+' : ''}${changePercent}%`;
    changeEl.className = `price-change ${isUp ? 'up' : 'down'}`;
  }

  const series = getSeriesForView();
  if (!series.length) return;

  let sum = 0;
  series.forEach(c => sum += c.close);
  document.getElementById('stat-avg').innerText = `$${(sum / series.length).toFixed(2)}`;

  const s24 = compute24hStats();
  if (s24) {
    document.getElementById('stat-high').innerText = `$${s24.high.toFixed(2)}`;
    document.getElementById('stat-low').innerText = `$${s24.low.toFixed(2)}`;
    document.getElementById('stat-vol').innerText = Math.round(s24.vol).toLocaleString();
  } else {
    document.getElementById('stat-high').innerText = `$${game.market.allTimeHigh.toFixed(2)}`;
    document.getElementById('stat-low').innerText = `$${game.market.allTimeLow.toFixed(2)}`;
    document.getElementById('stat-vol').innerText = Math.round(game.market.volume).toLocaleString();
  }

  if (!chartHover.active) updateOhlcBar(series[series.length - 1]);
}

function drawChart() {
  const plot = document.getElementById('chart-plot');
  if (!plot || plot.clientWidth === 0 || plot.clientHeight === 0) return;

  const series = getSeriesForView();
  if (series.length < 2) return;

  game.market.viewSeries = series;

  const { minP, maxP, range } = computeScale(series);
  game.market.view = { minP, maxP, range };

  updateGrid(minP, maxP);
  renderPriceLine(minP, range);
  renderCandles(series, minP, range);
  renderLine(series, minP, range);
  renderVolume(series);
  updateTimeLabels(series);
}

function hideCrosshair() {
  ['crosshair-v', 'crosshair-h', 'crosshair-price', 'crosshair-time'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  const tt = document.getElementById('chart-tooltip');
  if (tt) tt.style.display = 'none';
}

function onChartMove(e) {
  const plot = document.getElementById('chart-plot');
  const series = game.market.viewSeries;
  if (!plot || !series || !series.length) return;

  const rect = plot.getBoundingClientRect();
  const x = clamp(e.clientX - rect.left, 0, rect.width);
  const y = clamp(e.clientY - rect.top, 0, rect.height);

  const idx = clamp(Math.floor((x / rect.width) * series.length), 0, series.length - 1);
  const c = series[idx];
  chartHover.active = true;

  const cx = ((idx + 0.5) / series.length) * rect.width;

  const v = document.getElementById('crosshair-v');
  const h = document.getElementById('crosshair-h');
  const pTag = document.getElementById('crosshair-price');
  const tTag = document.getElementById('crosshair-time');

  if (v) { v.style.display = 'block'; v.style.left = `${cx}px`; }
  if (h) { h.style.display = 'block'; h.style.top = `${y}px`; }

  const { minP, range } = game.market.view;
  const priceAtCursor = minP + (1 - y / rect.height) * range;

  if (pTag) {
    pTag.style.display = 'block';
    pTag.style.top = `${y}px`;
    pTag.textContent = `$${priceAtCursor.toFixed(2)}`;
  }

  if (tTag) {
    tTag.style.display = 'block';
    tTag.style.left = `${cx}px`;
    tTag.textContent = fmtTime(c.time);
  }

  const tt = document.getElementById('chart-tooltip');
  if (tt) {
    const up = c.close >= c.open;
    tt.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:12px; margin-bottom:6px;">
        <span style="color:var(--text-dim)">Time</span>
        <span style="color:var(--text); font-weight:bold">${fmtTime(c.time)}</span>
      </div>
      <div style="display:flex; justify-content:space-between; gap:12px;">
        <span style="color:var(--text-dim)">Open</span>
        <span style="font-weight:bold; color:var(--text)">$${c.open.toFixed(2)}</span>
      </div>
      <div style="display:flex; justify-content:space-between; gap:12px;">
        <span style="color:var(--text-dim)">High</span>
        <span style="font-weight:bold; color:var(--chart-up)">$${c.high.toFixed(2)}</span>
      </div>
      <div style="display:flex; justify-content:space-between; gap:12px;">
        <span style="color:var(--text-dim)">Low</span>
        <span style="font-weight:bold; color:var(--chart-down)">$${c.low.toFixed(2)}</span>
      </div>
      <div style="display:flex; justify-content:space-between; gap:12px;">
        <span style="color:var(--text-dim)">Close</span>
        <span style="font-weight:bold; color:${up ? 'var(--chart-up)' : 'var(--chart-down)'}">$${c.close.toFixed(2)}</span>
      </div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:6px;">
        <span style="color:var(--text-dim)">Vol</span>
        <span style="font-weight:bold; color:var(--text)">${Math.round(c.volume).toLocaleString()}</span>
      </div>
    `;
    tt.style.display = 'block';

    const offset = 14;
    let left = e.clientX + offset;
    let top = e.clientY + offset;

    tt.style.left = left + 'px';
    tt.style.top = top + 'px';
    const r = tt.getBoundingClientRect();

    if (r.right > window.innerWidth - 8) left = e.clientX - r.width - offset;
    if (r.bottom > window.innerHeight - 8) top = e.clientY - r.height - offset;

    tt.style.left = left + 'px';
    tt.style.top = top + 'px';
  }

  updateOhlcBar(c);
}

function onChartLeave() {
  chartHover.active = false;
  hideCrosshair();
  const series = getSeriesForView();
  if (series.length) updateOhlcBar(series[series.length - 1]);
}

function initChartInteractions() {
  const plot = document.getElementById('chart-plot');
  if (!plot) return;

  plot.addEventListener('mousemove', onChartMove);
  plot.addEventListener('mouseleave', onChartLeave);

  // basic touch support
  plot.addEventListener('touchmove', (ev) => {
    if (!ev.touches || !ev.touches[0]) return;
    onChartMove(ev.touches[0]);
  }, { passive: true });

  plot.addEventListener('touchend', onChartLeave);
}

function setChartType(type) {
  game.chartType = type;
  document.getElementById('btn-candle').classList.toggle('active', type === 'candle');
  document.getElementById('btn-line').classList.toggle('active', type === 'line');

  const candle = document.getElementById('chart-display');
  const svg = document.getElementById('line-chart');

  if (candle) candle.style.display = type === 'candle' ? 'flex' : 'none';
  if (svg) svg.style.opacity = type === 'line' ? '1' : '0';

  drawChart();
}

function setTimeframe(tf) {
  if (!TIMEFRAMES[tf]) return;
  game.market.timeframe = tf;

  document.getElementById('tf-1m').classList.toggle('active', tf === '1m');
  document.getElementById('tf-5m').classList.toggle('active', tf === '5m');
  document.getElementById('tf-15m').classList.toggle('active', tf === '15m');

  chartHover.active = false;
  hideCrosshair();
  updateMarketUI();
  drawChart();
}

/* ============================================
   INVESTMENT
   ============================================ */
function updateInvestBar() {
  game.invest.chance += game.invest.direction * game.invest.speed;
  if (game.invest.chance >= 60) { game.invest.chance = 60; game.invest.direction = -1; }
  else if (game.invest.chance <= 0) { game.invest.chance = 0; game.invest.direction = 1; }

  const fill = document.getElementById('chance-fill');
  const txt = document.getElementById('win-chance-txt');
  if (fill && txt) {
    fill.style.width = game.invest.chance + '%';
    txt.innerText = Math.floor(game.invest.chance) + '%';
    txt.style.color = game.invest.chance < 20 ? '#ff3366' : (game.invest.chance > 50 ? '#10b981' : '#fbbf24');
  }
}

function investRisky() {
  if (game.money < 5000) {
    showMyPopup("C·∫¢NH B√ÅO", "D∆∞·ªõi $5,000 m√† ƒë·∫ßu t∆∞ th√¨ kh√°c g√¨ mu·ªëi b·ªè bi·ªÉn!", "#ff3366");
    return;
  }
  const allIn = game.money;
  const isWin = Math.random() * 100 <= game.invest.chance;

  if (isWin) {
    game.money += allIn;
    showMyPopup("TH·∫ÆNG L·ªöN!", `+$${allIn.toLocaleString()}`, "#10b981");
  } else {
    game.money = 0;
    showMyPopup("M·∫§T TR·∫ÆNG!", `M·∫•t $${allIn.toLocaleString()}!`, "#ff3366");
  }
  updateUI();
}

/* ============================================
   MAIN LOOP
   ============================================ */
setInterval(() => {
  updateInvestBar();

  if (game.items.miner.lv > 0 && !game.isOverheat) {
    const speedMult = 1 + (game.talent.levels.grease * 0.05);
    game.gas += (game.items.miner.lv * 0.2 * speedMult) / 10;
    game.temp += 0.03;
  }

  if (game.items.compressor.lv > 0 && game.gas >= 5) {
    const compressions = Math.min(game.items.compressor.lv, Math.floor(game.gas / 5));
    game.gas -= compressions * 5;
    game.hdpe += compressions;
  }

  const cool = 0.1 + (game.items.coolant.lv * 0.05);
  if (game.temp > 0) game.temp -= cool;
  if (game.temp < 0) game.temp = 0;

  if (game.temp >= 100) game.isOverheat = true;
  if (game.isOverheat && game.temp <= (game.licenses.cooling ? 80 : 50)) game.isOverheat = false;

  game.manager.timer++;
  if (game.manager.timer > 10 && game.manager.active) {
    game.manager.timer = 0;
    const list = Object.keys(game.items).map(k => ({ k, ...game.items[k] })).sort((a, b) => a.cost - b.cost);
    if (game.money >= list[0].cost) buyUpgrade(list[0].k);
  }

  updateUI();
}, 100);

/* Market realtime */
seedMarket();
initChartInteractions();
setTimeframe('1m');
setChartType('candle');
updateMarketUI();
setInterval(marketTick, MARKET_TICK_MS);

/* ============================================
   UI UPDATE
   ============================================ */
function updateUI() {
  document.getElementById('money-display').innerText = Math.floor(game.money).toLocaleString();
  document.getElementById('gas-display').innerText = Math.floor(game.gas).toLocaleString();
  document.getElementById('hdpe-display').innerText = Math.floor(game.hdpe).toLocaleString();
  document.getElementById('tp-display').innerText = game.talent.tp.toLocaleString();
  document.getElementById('storage-display').innerText = game.storage.toLocaleString();

  document.getElementById('temp-val').innerText = Math.floor(game.temp);
  document.getElementById('temp-bar').style.width = game.temp + '%';
  document.getElementById('overheat-warning').style.display = game.isOverheat ? 'block' : 'none';

  for (let k in game.items) {
    document.getElementById(`cost-${k}`).innerText = game.items[k].cost.toLocaleString();
    document.getElementById(`lvl-${k}`).innerText = game.items[k].lv;
  }

  const speedMult = 1 + (game.talent.levels.grease * 0.05);
  document.getElementById('auto-rate-display').innerText = (game.items.miner.lv * 0.2 * speedMult).toFixed(1);

  document.getElementById('tp-val-big').innerText = game.talent.tp;
  document.getElementById('cost-talent-efficiency').innerText = Math.floor(1 + game.talent.levels.efficiency * 0.5);
  document.getElementById('lvl-talent-efficiency').innerText = game.talent.levels.efficiency;

  if (game.talent.levels.efficiency >= 5) {
    document.getElementById('node-luck').classList.remove('locked');
    document.getElementById('node-luck').querySelector('.talent-cost').innerText = "Chi ph√≠: 1 TP";
  }
  document.getElementById('lvl-talent-luck').innerText = game.talent.levels.luck;
  document.getElementById('cost-talent-grease').innerText = Math.floor(1 + game.talent.levels.grease * 0.5);
  document.getElementById('lvl-talent-grease').innerText = game.talent.levels.grease;

  if (game.licenses.export) document.getElementById('lic-export').classList.add('owned');
  if (game.licenses.cooling) document.getElementById('lic-cooling').classList.add('owned');

  const reqExp = document.getElementById('req-export-lvl');
  if (game.talent.levels.efficiency >= 10) {
    reqExp.style.color = '#10b981';
    reqExp.innerText = "‚úì ƒê·ªß ƒëi·ªÅu ki·ªán";
  }

  const reqCool = document.getElementById('req-cooling-res');
  if (game.storage >= 50000) {
    reqCool.style.color = '#10b981';
    reqCool.innerText = "‚úì ƒê·ªß ƒëi·ªÅu ki·ªán";
  }

  if (game.manager.owned) {
    document.getElementById('manager-locked').style.display = 'none';
    document.getElementById('manager-unlocked').style.display = 'block';
  }
  document.getElementById('mgr-status-text').innerText = game.manager.active ? 'ƒêANG HO·∫†T ƒê·ªòNG' : 'ƒêANG T·∫ÆT';
  document.getElementById('mgr-toggle').className = 'toggle-btn' + (game.manager.active ? ' on' : '');
  document.getElementById('mgr-toggle').innerText = game.manager.active ? 'T·∫ÆT QU·∫¢N L√ù' : 'B·∫¨T QU·∫¢N L√ù';
}

/* ============================================
   CHEAT (Ctrl + Q)
   ============================================ */
window.addEventListener('keydown', function(e) {
  if (e.ctrlKey && (e.key === 'q' || e.key === 'Q')) {
    e.preventDefault();
    const input = prompt("CHEAT: Nh·∫≠p s·ªë ti·ªÅn:");
    if (input !== null && input !== "") {
      const amount = parseInt(input);
      if (!isNaN(amount)) {
        game.money += amount;
        updateUI();
        showMyPopup("CHEAT", `+$${amount.toLocaleString()}`, "#10b981");
      }
    }
  }
});

/* Initial */
updateUI();
</script>

</body>
</html>
